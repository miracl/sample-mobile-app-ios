## DVSSample
* **category**: Samples
* **copyright**: 2019 MIRACL Technologies LTD
* **link**: https://github.com/miracl/sample-mobile-app-ios/tree/master/DVSSample/

## Description
This sample demonstrates how to use the [MIRACL iOS SDK](https://github.com/miracl/mfa-client-sdk-ios) in order to sign a transaction which can only be verified by a designated verifier using the [MIRACL MFA Platform](https://trust.miracl.cloud/) via an iOS device. These are the so-called **DVS Registration** and **DVS Signing** flows and here is the methods sequence user needs to follow in order to achieve it:

<img src="https://raw.githubusercontent.com/miracl/mfa-client-sdk-ios/master/docs/DvsRegistration_short.png" width="700">

<img src="https://raw.githubusercontent.com/miracl/mfa-client-sdk-ios/master/docs/DvsSigning_short.png" width="700">

## Requirements
* MacOS Mojave or newer
* iOS 12 or newer

## Setup
1. Checkout the sample projects `https://github.com/miracl/sample-mobile-app-ios`
2. [Run a backend application](#create-a-demo-web-app-to-act-as-a-backend-service)
3. [Configure the app with the issued credentials](#configure-the-app-with-the-issued-credentials)
4. Build the project:
	1. From command line open the root dir from the checked out project. Navigate to folder DVSSample.
	2. Execute the following command:
	>> pod install
	3. Open the .xcworkspace file which is located in the current directory.

### Create a demo web app to act as a backend service
In order to be able to test the demo `DVS` sample app, you need to run a backend service as a relying party demo web app (RPA). The demo app should authenticate to the [MIRACL Trust authentication portal](https://trust.miracl.cloud/), called also MFA, using [OpenIDConnect](https://openid.net/connect/) protocol. More information could be found [here](http://docs.miracl.cloud/oidc-client-setup/). This means you need to login and create an application in the portal and use its credentials (`client id` and `client secret`) in the demo web app for the communication.

This sample uses the mobile app login in order to register and authenticate an identity so it can make DVS operations with it. This means that the web app should implements the following endpoints as it is done at [this sample RPA project](https://github.com/miracl/maas-sdk-dotnet-core2#sample-endpoints):
* POST `/authzurl`
 This should return the following json formatted data on success as it's done [here](https://github.com/miracl/maas-sdk-dotnet-core2/blob/master/MiraclDvsSigningApp.Core2.0/Controllers/authzurlController.cs#L6):
```
{
    "authorizeURL": "<- The authorization url to the MFA ->"
}
```
* POST `/authtoken`
 This endpoint should authenticate by a specified Authorization Code and User ID, passed in the following format:
```
{
    "code":"<- the authorization code to validate with ->",
    "userID":"<- the authorized email to be verified ->"
}
```
The http status code of the response could correspond to the status of the authentication. A sample could be found [here](https://github.com/miracl/maas-sdk-dotnet-core2/blob/master/MiraclDvsSigningApp.Core2.0/Controllers/authtokenController.cs#L13).

Two more endpoints are necessary for the DVS operations:
* POST `/document`
The user signs a hash of the document, not the document itself. The web demo needs to have an endpoint to create this hash. It should accept the document to be signed and return its hash and a time stamp of its creation. By default SHA256 algorithm is used to compute the hash.
You could review a sample handler for this [here](https://github.com/miracl/maas-sdk-dotnet-core2/blob/master/MiraclDvsSigningApp.Core2.0/Controllers/loginController.cs#L53).

* POST `/verify-signature`
An additional call to the web demo should verify if the document hash is properly signed. There should be an endpoint which accepts a json formatted signature data with the following structure:
```
{
    "hash" : "<- the hash of the signed document ->",
    "mpinId" : "<- the M-Pin ID used to generate the signature ->",
    "u" : "<- the random commitment generated by the user ->",
    "v" : "<- the proof of the signature ->",
    "publicKey" : "<- the user public key used in the key-escrow less scheme (if supported) ->",
    "dtas" : "<- the DTAs used for signing ->"
}
```
and returns true/false if the signature is valid or not. [Here](https://github.com/miracl/maas-sdk-dotnet-core2/blob/master/MiraclDvsSigningApp.Core2.0/Controllers/loginController.cs#L66) is a sample handler you could review for a reference.

Once you have run the demo web app you need to host it on a visible URI for the mobile app. Just reassure that the proper redirect URI (`demoAppUri/login`) is added as a redirect URI to the [authentication portal](https://trust.miracl.cloud/) application settings you're running the web app with:

<img src="Docs/redirect-url-private-ip.png" width="400">

### Configure the app with the issued credentials

Before starting the iOS application, you need to configure it through the [`Config.m`](DVSSample/model/Config.m) file:

```
+ (NSString *)companyId
{
  return <# Replace with your company id #>;
}

+ (NSString *)accessCodeServiceBaseUrl
{
  return  <# Replace with backend ip/domain hostname #> ;
}

+ (NSNumber *)accessCodeServicePort
{
  return [NSNumber numberWithInteger: <# Replace with backend ip/domain port number #>];
}

+ (NSString *)httpScheme
{
  return <# Replace with http scheme value #>;
}

+ (NSString *)authBackend
{
  return @"https://api.mpin.io";
}
```

As the owner of the MFA web app, your `Company ID` is visible as a tooltip in the top right corner of your company dashboard in the MFA portal:

<img src="Docs/view-co-id.png" width="400">

Note that `authBackend` method should always return https://api.mpin.io URL in order to authenticate against [MIRACL Trust authentication portal](https://trust.miracl.cloud/).

## **DVS Sample** implementation by MIRACL iOS SDK

Ð¢his sample uses **Registration** and **Mobile App Login** flows, which are explained in detail [here](https://github.com/miracl/sample-mobile-app-ios/tree/master/MobileAppLoginSample/README.md#mobile-app-login-flow-implementation-by-miracl-ios-sdk), in order to login into the mobile app itself. In this documentation, we focus only on the **DVS** implementation flows, so we assume that the user has already been issued with a `user ID` and an `access token`.

Also since most of the Miracl iOS SDK methods are long-term operations, it is recommended to be called on background queue with `NSOperationQueue` or `Grand Central Dispatch`. You could see this pattern through the sample application.

### SDK initialization
First step of SDK initialization is done at [`AppDelegate.m`](DVSSample/AppDelegate.m) in `application: didFinishLaunchingWithOptions:` method, where [`[MPinMFA initSDK]`](https://github.com/miracl/mfa-client-sdk-ios#void-initsdk) and [`[MPinMFA SetClientId:]`](https://github.com/miracl/mfa-client-sdk-ios#void-setclientid-nsstring-clientid) methods are called:
```
[MPinMFA initSDK];
[MPinMFA SetClientId: [Config companyId]];
```

## DVS Registration

The user needs to have a DVS identity (different than their authentication identity with the same user id) in order to sign documents, which is implemented at [`DVSRegistrationViewController.m`](DVSSample/viewcontroller/DvsRegistrationViewController.m). If a user has a DVS identity could be checked by [self.currentUser canSign](https://github.com/miracl/mfa-client-sdk-ios#idiuser-makenewuser-const-nsstring-identity-devicename-const-nsstring-devname) method. If it returns true, this identity could be used to [sign transactions](#dvs-signing). If it returns false, you need to create a signing identity for it. They need to authenticate first. That's why when `DVS REGISTER` button is clicked user first needs to enter their authentication identity PIN and after that [`[MPinMFA StartRegistrationDVS: pin0: pin1:]`](https://github.com/miracl/mfa-client-sdk-ios/tree/master#mpinstatus-startregistrationdvs-const-idiuser-user-pin0nsstring--pin0-pin1nsstring--pin1) method is called:

<img src="Docs/dvs-register-user.png" width="400">

```
MpinStatus *status = [MPinMFA StartRegistrationDVS:self.appDelegate.currentUser pin0:pin pin1:nil];
```

If the authentication succeeded, the user is asked for their DVS Signing PIN. Then [`[MPinMFA FinishRegistrationDVS: pinDVS: nfc:]`](https://github.com/miracl/mfa-client-sdk-ios#mpinstatus-finishregistrationdvs-const-idiuser-user-pindvs-nsstring-pindvs-nfc-nsstring-nfc) method is called to complete their DVS Identity registration. Then the user could sign documents using the [`SignMessageViewController.m`](DVSSample/viewcontroller/SignMessageViewController.m) logic.
```
MpinStatus *status = [MPinMFA FinishRegistrationDVS:self.appDelegate.currentUser pinDVS:pin nfc:nil];
```

### DVS Signing

For simplicity signing in [`SignMessageViewController.m`](DVSSample/viewcontroller/SignMessageViewController.m) is done for a simple string, but could be done for different resources like files or pictures, that could be represented as a string. Keep in mind, that better usage of DVS is to sign the document hash, not the whole file instead.

<img src="Docs/sign-screen.png" width="400">

The user needs to enter some text and click `SIGN` button. The DVS Identity signing PIN is required to sign the text.
Method `createDocumentHash` of [`AccessCodeServiceApi`](DVSSample/service/AccessCodeServiceApi.m) is executed to create a transaction of type [`DocumentDvsInfo`](DVSSample/model/DocumentDvsInfo.h) from the document text by making a `POST` request to the RPA backend service.

This transaction needs to be verified by [`[MPinMFA VerifyDocument: hash:]`](https://github.com/miracl/mfa-client-sdk-ios#bool-verifydocument-nsstring-strdoc-hash-nsdata-hash) method so the user is sure that the hash is correct.

```
BOOL verifiedDocument = [MPinMFA VerifyDocument:message hash:documentHash];
if (!verifiedDocument) {
    // ...
}
```

To sign the transaction [`[MPinMFA Sign: documentHash: pin0: pin1: epochTime: result:]`](https://github.com/miracl/mfa-client-sdk-ios#mpinstatus-sign-idiuser-user-documenthash-nsdata-documenthash-pin0-nsstring-pin0-pin1-nsstring-pin1-epochtime-double-epochtime-result-bridgesignature-result) method is used:
```
id<IUser> user = self.appDelegate.currentUser;
double time = (double)info.timestamp;
BridgeSignature *bridgeSignature = nil;
MpinStatus *status = [MPinMFA Sign:user documentHash:[info.hashValue dataUsingEncoding:NSUTF8StringEncoding] pin0:pin pin1:nil epochTime:time result:&bridgeSignature];
```

If `status` result is `OK`, the user can verify the validity of the provided PIN with `verifySignature` method of [`AccessCodeServiceApi`](DVSSample/service/AccessCodeServiceApi.m). The result is displayed to the screen:

<img src="Docs/dvs-verify-success.png" width="400">

### See also:
1. [MobileLoginSample](https://github.com/miracl/sample-mobile-app-ios/tree/master/MobileLoginSample)
2. [WebsiteLoginSample](https://github.com/miracl/sample-mobile-app-ios/tree/master/WebsiteLoginSample)
3. [BootstrapSample](https://github.com/miracl/sample-mobile-app-ios/tree/master/BootstrapSample)
